%
% Copyright (C) 2008-2011 Alexis Bienvenue
%
% This file is part of Auto-Multiple-Choice
%
% Auto-Multiple-Choice is free software: you can redistribute it
% and/or modify it under the terms of the GNU General Public License
% as published by the Free Software Foundation, either version 2 of
% the License, or (at your option) any later version.
%
% Auto-Multiple-Choice is distributed in the hope that it will be
% useful, but WITHOUT ANY WARRANTY; without even the implied warranty
% of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Auto-Multiple-Choice.  If not, see
% <http://www.gnu.org/licenses/>.
%
% $Revision$
% 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{automultiplechoicepos}
\RequirePackage{xcolor} % \fcolorbox to fill (or not) a box
\RequirePackage{fancyhdr} % \pagestyle{empty}
\RequirePackage{bophook} % \AtBeginPage
\RequirePackage{keyval} % \setkeys
\RequirePackage{rotating} % \rotatebox
%
\def\AMCtext#1#2{\expandafter\def\csname AMC@loc@#1\endcsname{#2}}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% localisation : english
%
% watermark for drafts
\def\AMC@loc@draft{DRAFT}
%
% message at page bottom when compiled out of AMC gui
\def\AMC@loc@message{For your examination, preferably print documents compiled from auto-multiple-choice.}
%
% annoucing a question in a separate sheet (#1=question number)
\def\AMC@loc@qf#1{{\bf Question #1:}}
%
% annoucing a question (#1=question number,
%                       #2=multiple question symbol, or empty)
\def\AMC@loc@q#1#2{{\bf Question #1} #2}
%
% headers for corrected version / catalog
%
\def\AMC@loc@corrected{Corrected}
\def\AMC@loc@catalog{Catalog}
%
% see completemulti option
%
\def\AMC@loc@none{None of these answers are correct.}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% localisation : french
\def\AMC@loc@FR{
%
\def\AMC@loc@draft{PROJET}
\def\AMC@loc@message{Pour votre examen, imprimez de pr\'ef\'erence les documents compil\'es \`a l'aide de auto-multiple-choice.}
\def\AMC@loc@qf##1{{\bf Question ##1 :}}
\def\AMC@loc@q##1##2{{\bf Question ##1} ##2}
\def\AMC@loc@corrected{Correction}
\def\AMC@loc@catalog{Catalogue}
\def\AMC@loc@none{Aucune de ces r\'eponses n'est correcte.}
%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newwrite\AMC@logfile
\immediate\openout\AMC@logfile=\jobname.amc
\def\AMC@amclog#1{\immediate\write\AMC@logfile{#1}}
%
%--------------------------------------------------------------
% pseud-random generator, cf. TuGBoat1994, vol 15,1
%--------------------------------------------------------------
\ifx\AMC@SR\undefined\newcount\AMC@SR\fi
\providecommand\AMC@SRconst{2097152}
\providecommand\AMC@SRset[1]{\global\AMC@SR#1 \ignorespaces}
\providecommand\AMC@SRadvance{%
  \begingroup
  \ifnum\AMC@SR<\AMC@SRconst\relax\AMC@SR@count\z@\else\AMC@SR@count\@ne\fi
  \ifodd\AMC@SR\advance\AMC@SR@count\@ne\fi
  \global\divide\AMC@SR\tw@
  \ifodd\AMC@SR@count\global\advance\AMC@SR\AMC@SRconst\relax\fi
  \endgroup}
\providecommand\AMC@SRbit{\AMC@SRadvance\ifodd\AMC@SR1\else0\fi}
\providecommand\AMC@SRtest[2]{\AMC@SRadvance
  \ifodd\AMC@SR#2\else#1\fi\ignorespaces}
\providecommand\AMC@SRvalue{\number\AMC@SR }
\AMC@SRset{1515}
%
\def\AMCrandomseed#1{\AMC@SRset{#1}}
%--------------------------------------------------------------
% uniform random sampling
%--------------------------------------------------------------
\newcount\AMC@SR@count
\def\AMC@SR@time{\AMC@SRset{\time}}
\newcount\AMC@SRnum
\def\AMC@SRnextByte{\AMC@SRnum=0
\AMC@SR@count=20
\loop\multiply\AMC@SRnum by 2
     \AMC@SRtest{\advance\AMC@SRnum by 1}{}
\ifnum\AMC@SR@count>1\advance\AMC@SR@count by -1\repeat
}
% random sampling in {0,1,...,#1-1} -> \AMC@SRnum
% #1 must be less than 2^20
\newcommand\AMC@SRmax[1]{\AMC@SRnextByte
\AMC@SR@count=\AMC@SRnum
\divide\AMC@SR@count by #1
\multiply\AMC@SR@count by #1
\advance\AMC@SRnum by -\AMC@SR@count
}
%--------------------------------------------------------------
% tokens shuffling
%--------------------------------------------------------------
\newcount\AMC@sti
\newtoks\AMCsw@p@
\newcommand\AMCsw@p[2]{\global\AMCsw@p@=#1 \global #1=#2 \global #2=\AMCsw@p@}
\newcommand\AMC@shuffletoks[2]{ % ARGS : number_of_tokens base_name
  \AMC@sti=#1
  \@whilenum\AMC@sti>1\do{
  \AMC@SRmax{\AMC@sti}\advance\AMC@SRnum by 1
% debug: show swaps
%  \number\AMC@SRnum$\leftrightarrow$\number\AMC@sti\par
  \AMCsw@p{\csname #2\romannumeral\AMC@SRnum\endcsname}{\csname #2\romannumeral\AMC@sti\endcsname}
  \advance\AMC@sti by -1
}}
%--------------------------------------------------------------
% affecte un numero unique a chaque cle utilisee...
%--------------------------------------------------------------
% definit la valeur asociee a une cle
\def\AMC@definitnumero#1#2{\AMC@amclog{AUTOQCM[NUM=#1=#2]^^J}\expandafter\global\expandafter\def\csname AMC@numtab@#2\endcsname{#1}}
% le compteur des numeros deja utilises
\newcount\AMC@numerotation\AMC@numerotation=1
% renvoie, si elle existe, la valeur deja associee, ou en associe une
% nouvelle et la renvoie
\def\AMC@prepare#1{\expandafter\ifx\csname AMC@numtab@#1\endcsname\relax\global\advance\AMC@numerotation by 1\expandafter\AMC@definitnumero\expandafter{\the\AMC@numerotation}{#1}\fi}
\def\AMC@unnumero#1{\AMC@prepare{#1}\csname AMC@numtab@#1\endcsname}
\def\AMC@affecte#1#2{\AMC@prepare{#1}#2=\csname AMC@numtab@#1\endcsname}
%
%--------------------------------------------------------------
% general
%--------------------------------------------------------------
\newcount\AMCload@counter % nombre de reponses chargees pour la question en cours
\newcount\AMCnum@questions
\def\AMCid@name{} % code de la question en coure
\newcount\AMCid@quest\AMCid@quest=-1 % numero de la question en cours
\newcount\AMCid@check % code de verification de la question en cours
\newcount\AMCid@etud\AMCid@etud=1 % numero de la copie en cours
\newcount\AMCid@etudfin % numero de la copie a laquelle on va s'arreter
\newcount\AMCnum@copies % nombre de copies
% options :
\newif\ifAMC@ordre\AMC@ordrefalse % on laisse les reponses dans l'ordre
\newif\ifAMC@correchead\AMC@correcheadfalse % en-tete corrige
\newif\ifAMC@affichekeys\AMC@affichekeysfalse % affichage des noms des exercices
\newif\ifAMC@correc\AMC@correcfalse % corrige des questions
\newif\ifAMC@qbloc\AMC@qblocfalse % on met les questions dans des blocs, pour ne pas les couper par des sauts de page
\newif\ifAMC@rbloc\AMC@rblocfalse % on met les reponses dans des blocs, pour ne pas les couper par des sauts de page (par ex dans multicol)
\newdimen\AMCinterIrep\AMCinterIrep=0pt % espace supplementaire entre les reponses classiques
\newdimen\AMCinterBrep\AMCinterBrep=.5ex % espace entre les reponses bloc
\def\AMCBoxedAnswers{\AMC@rbloctrue}
\newif\ifAMCcomplete@multi\AMCcomplete@multifalse % on complete les questions multi par une option "rien n'est bon"
\newif\ifAMC@calibration\AMC@calibrationfalse % on veut fabriquer le document de calibration (couleurs speciales)
\newif\ifAMC@codebinaire\AMC@codebinairetrue % le code est ecrit en binaire
\newif\ifAMC@plain\AMC@plainfalse
\newif\ifAMCune@bonne % il y a au moins une bonne reponse dans la question en cours
\newif\ifAMCtype@multi % la question en cours est de type multiple
\newif\ifAMC@watermark\AMC@watermarktrue
\newif\ifAMC@ensemble\AMC@ensemblefalse % les cases a cocher sont mises ensemble a la fin
\newif\ifAMC@ensemble@chiffres\AMC@ensemble@chiffresfalse % mettre des chiffres dans les cases plutot que des lettres
\newdimen\AMCformVSpace\AMCformVSpace=1.2ex % espace vertical entre deux questions dans la page separee
\newdimen\AMCformHSpace\AMCformHSpace=.3em % espace horizontal entre deux reponses dans la page separee
% tests internes...
\newif\ifAMCformulaire@dedans\AMCformulaire@dedansfalse
\newif\ifAMC@zoneformulaire
%
% -----------------------------------------------------------------------
% Draw boxes, and log position information for these boxes
% -----------------------------------------------------------------------
%
% \tracebox draws some content, with some output from which one will be able to
% compute the exact position of a box containing this content.
% #1 = trace position ?
% #2 = key (identifier)
% #3 = content
\def\tracepos#1#2{\ifAMC@calibration\ifx\@empty#1\@empty\else\pdfsavepos\protected@write\AMC@XYFILE{}{%
      \string\tracepos%
        {\the\AMCid@etud/\thepage:#2}{\noexpand\number\pdflastxpos sp}{\noexpand\number\pdflastypos sp}}%
\fi\fi}
\def\traceposx#1#2{\ifAMC@calibration\ifx\@empty#1\@empty\else\pdfsavepos\protected@write\AMC@XYFILE{}{%
      \string\tracepos%
        {\the\AMCid@etud/\thepage:#2}{\noexpand\number\pdflastxpos sp}{0sp}}%
\fi\fi}
\def\traceposy#1#2{\ifAMC@calibration\ifx\@empty#1\@empty\else\pdfsavepos\protected@write\AMC@XYFILE{}{%
      \string\tracepos%
        {\the\AMCid@etud/\thepage:#2}{0sp}{\noexpand\number\pdflastypos sp}}%
\fi\fi}
\long\def\tracebox#1#2#3{\vbox{\traceposy{#1}{#2}\leavevmode\traceposx{#1}{#2}#3\traceposx{#1}{#2}}\traceposy{#1}{#2}}
\def\pagepos{\ifAMC@calibration\protected@write\AMC@XYFILE{}{\string\page{\the\AMCid@etud/\thepage/\the\AMCid@check}{\the\paperwidth}{\the\paperheight}}\fi}
%
% parametres codage et cases binaires
\def\AMCid@checkmax{60} % code de verification maximal
\def\AMC@NCBetud{12}
\def\AMC@NCBpage{6}
\def\AMC@NCBcheck{6}
\newlength{\AMC@CBtaille}\setlength{\AMC@CBtaille}{5cm}
\def\AMC@premierecopie{1}
%
% AMC@boxedchar: draws a box with a character in it.
% #1 = content of the box (the character)
% #2 = trace position ?
% #3 = box ID key
% #4 = fill the box ?
\newcommand\AMC@boxedchar[4]{\hspace{0pt}{\fboxsep=0pt\fboxrule=\AMC@boxedrule\lower\AMC@boxeddown\hbox{\fcolorbox{black}{\ifx\@empty#4\@empty white\else black\fi}{\vbox to \AMC@boxeddim{\tracepos{#2}{#3}\vfill \hbox to \AMC@boxeddim{\hfill{#1}\hfill}\vfill}\tracepos{#2}{#3}}}}}
%
% AMC@caselettre: the same as AMC@boxedchar, but if #1 (content) is empty,
% use a (arabic or alphanumeric) counter
\newcounter{AMC@ncase}
\setcounter{AMC@ncase}{0}
\newcommand\AMC@caselettre[4]{%
\AMC@boxedchar{\ifx\@empty#1\@empty\ifAMC@ensemble@chiffres\arabic{AMC@ncase}\else\Alph{AMC@ncase}\fi\else #1\fi}{#2}{#3}{#4}}
%
% dimensions management for AMC@boxedchar
%
\newlength\AMC@boxedrule
\newlength\AMC@boxeddown
\newlength\AMC@boxeddim
\define@key{AMCdim}{size}{\AMC@boxeddim=#1}
\define@key{AMCdim}{rule}{\AMC@boxedrule=#1}
\define@key{AMCdim}{down}{\AMC@boxeddown=#1}
\def\AMCboxDimensions#1{\setkeys{AMCdim}{#1}}
\AMCboxDimensions{size=2.5ex,down=.4ex,rule=.5pt}
%
% AMC@marque draws a box
% #1 = character to place in the box
% #2 = fill the box ?
\newcommand{\AMC@marque}[2]{%
  \ifAMC@ensemble%
    \ifAMC@zoneformulaire % for codes inside form sheet
      \protect\AMC@caselettre{#1}{1}{case:\AMCid@name:\the\AMCid@quest,\the\AMCrep@count}{#2}%
    \else%
    \ifAMCformulaire@dedans% for answer boxes inside form sheet
      \protect\AMC@caselettre{#1}{1}{case:\AMCid@name:\the\AMCid@quest,\the\AMCrep@count}{#2}%
    \else% outside form sheet: not to be read
      \AMC@caselettre{#1}{}{}{#2}%
    \fi\fi%
  \else% no separate sheet for answers: always read
    \AMC@boxedchar{}{1}{case:\AMCid@name:\the\AMCid@quest,\the\AMCrep@count}{#2}%
  \fi%
}
%
% champ a remplir pour mettre son nom -> bonne couleur
\newcommand{\champnom}[1]{\tracebox{1}{nom}{#1}}
%
%--------------------------------------------------------------
% binary boxes
%--------------------------------------------------------------
%
\newtoks\en@binaire
\newcount\le@nombre
\newcount\nb@chiffres
\newcount\nb@id
\newcount\numer@casebinaire
%
\def\chiffre@un{\advance\numer@casebinaire by 1\AMC@boxedchar{}{1}{chiffre:\the\nb@id,\the\numer@casebinaire}{1}}
\def\chiffre@zero{\advance\numer@casebinaire by 1\AMC@boxedchar{}{1}{chiffre:\the\nb@id,\the\numer@casebinaire}{}}
%
\def\commence@nb#1{\nb@id=#1\numer@casebinaire=0}
\newcommand\chiffresbinaires[2]{
\def\chiffre@zero{#1}
\def\chiffre@un{#2}
}
\newcommand{\binaire}[2][1]{%
{\AMCboxDimensions{size=.3cm,down=0pt,rule=.2pt}\en@binaire={}\le@nombre=#2%
\nb@chiffres=0%
\loop%
\ifnum\le@nombre>0%
\advance\nb@chiffres by 1%
\ifodd\le@nombre\en@binaire=\expandafter{\expandafter\chiffre@un\the\en@binaire}%
\else\en@binaire=\expandafter{\expandafter\chiffre@zero\the\en@binaire}\fi%
\divide\le@nombre by 2%
\repeat%
\loop\relax%
\ifnum\nb@chiffres<#1\advance\nb@chiffres by 1%
\en@binaire=\expandafter{\expandafter\chiffre@zero\the\en@binaire}\repeat%
\the\en@binaire%
}}
%
%--------------------------------------------------------------
% groups; shuffling groups members
%--------------------------------------------------------------
%
\newcount\AMCtok@k
\newcount\AMCtok@max
\newcommand{\nouveaugroupe}[2]{% nom_groupe (nombre_max)
% (le deuxieme argument ne sert plus a rien)
% definition du compteur
\expandafter\newcount\csname #1@k\endcsname
\csname #1@k\endcsname=0
}
\newcommand{\element}[2]{% nom_groupe tok
  % definition du compteur si pas deja fait
  \expandafter\ifx\csname #1@k\endcsname\relax\nouveaugroupe{#1}{}\fi
  % augmentation du compteur
  \advance\csname #1@k\endcsname by 1
  \AMCtok@k=\csname #1@k\endcsname
  \expandafter\ifx\csname #1@\romannumeral\AMCtok@k\endcsname\relax\expandafter\newtoks\csname #1@\romannumeral\AMCtok@k\endcsname\fi
  \csname #1@\romannumeral\AMCtok@k\endcsname={#2}
}
\newcommand{\shufflegroup}[1]{%
  {\AMC@shuffletoks{\number\csname #1@k\endcsname}{#1@}}
}
\newcommand{\insertgroup}[2][0]{%
\AMCtok@max=#1
\ifnum\the\AMCtok@max<1
  \AMCtok@max=\csname #2@k\endcsname
\fi
\AMCtok@k=0
%
{\loop
    \advance\AMCtok@k by 1
    \the\csname #2@\romannumeral\AMCtok@k\endcsname
\ifnum\AMCtok@k<\AMCtok@max\repeat}%
}
%
%--------------------------------------------------------------
% questions
%--------------------------------------------------------------
%
\newcount\AMCrep@count
\newcount\AMCrep@@count
% nbre maximal de reponses :
\AMCload@counter=199
% definition des registres de tokens
\@whilenum\AMCload@counter>0\do{
  \expandafter\newtoks\csname reponse@\romannumeral\AMCload@counter\endcsname
  \advance\AMCload@counter by -1
}
\newcommand\AMCload@reponse[2]{%
  \advance\AMCload@counter by 1
  \csname reponse@\romannumeral\AMCload@counter\endcsname=\expandafter{\expandafter\AMCrep@count\expandafter=#2 #1}
}
\newcommand\AMCrien@deux[2]{#1}
\newcommand\AMCdump@reponses{\global\AMCnum@questions=\AMCload@counter\@whilenum\AMCload@counter>0\do{\the\csname reponse@\romannumeral\AMCload@counter\endcsname\advance\AMCload@counter by -1}}
\def\shuffle@it{\AMC@shuffletoks{\number\AMCload@counter}{reponse@}}
%
\newcommand\AMCrep@init[1]{\ifAMC@ordre\AMCrep@o\else\csname AMCrep@#1\endcsname\fi\AMCload@counter=0}
\newcommand\lastchoices{\AMCrep@@count=\AMCrep@count\AMCrep@fini\AMCrep@init{o}\AMCrep@count=\AMCrep@@count}
\newcommand\AMC@fin@rep{\ifAMCcomplete@multi\ifAMCtype@multi\lastchoices\AMCrep@count=-1\ifAMCune@bonne\wrongchoice{\@aucune}\else\correctchoice{\@aucune}\fi\fi\fi\AMCrep@fini}
%
\newenvironment{choices}[1][r]{\AMCrep@count=0\def\une@rep{\AMCrep@itemize}\ifAMC@rbloc\def\une@rep{\AMCrep@bloc}\else\begin{itemize}\setlength{\itemsep}{\AMCinterIrep}\fi\AMCrep@init{#1}}{\AMC@fin@rep\ifAMC@rbloc\else\end{itemize}\fi}
%
\newenvironment{choiceshoriz}[1][r]{\AMCrep@count=0\def\une@rep{\AMCrep@ligne}\AMCrep@init{#1}\par\begin{center}}{\AMC@fin@rep\end{center}}
\newenvironment{choicescustom}[1][r]{\AMCrep@count=0\def\une@rep{\AMCrep@perso}\AMCrep@init{#1}\AMCbeginAnswer}{\AMC@fin@rep\AMCendAnswer}
%
\newcommand\AMCrep@o{\def\AMCload@@reponse{\AMCrien@deux}\def\AMCrep@fini{}}
\newcommand\AMCrep@r{\def\AMCload@@reponse{\AMCload@reponse}\def\AMCrep@fini{\shuffle@it\AMCdump@reponses}}
%
% memoire pour mettre les cases a cocher en fin de copie
%
\def\AMCmem@ireData{}
\def\AMCformQuestion#1{\vspace{\AMCformVSpace}\par{\AMC@loc@qf{#1}}}
\def\AMCformQuestionA#1{\setcounter{AMC@ncase}{0}\AMCformQuestion{#1}}
\def\AMCformAnswer#1{\hspace{\AMCformHSpace} #1}
\def\AMCformAnswerA#1{\addtocounter{AMC@ncase}{1}\AMCformAnswer{#1}}
\def\AMCformBegin{\AMC@zoneformulairetrue}
%
\newcommand\AMCmem@ireAJ[1]{\ifAMC@ensemble\ifAMC@zoneformulaire\else\begingroup\AMCformulaire@dedanstrue\let\protect\@unexpandable@protect\global\edef\AMCmem@ireData{\AMCmem@ireData #1}\endgroup\fi\fi}
\newcommand\AMCmem@ireAJRep[1]{\addtocounter{AMC@ncase}{1}\AMCmem@ireAJ{\protect\AMCformAnswerA{#1}}}
\newcommand\AMCmem@ireQ[1]{\AMCmem@ireAJ{\protect\AMCformQuestionA{#1}}}
\newcommand\AMCform{\ifAMC@ensemble\AMCformulaire@dedanstrue\AMCmem@ireData\global\def\AMCmem@ireData{}\fi}
%
% mise en forme des questions
%
\newcommand\AMCrep@bloc[2]{\AMCmem@ireAJRep{#1}\par\noindent\begin{minipage}{\linewidth}\begin{itemize}\item[#1] #2\end{itemize}\end{minipage}\vspace{\AMCinterBrep}}
\newcommand\AMCrep@itemize[2]{\AMCmem@ireAJRep{#1}\item[#1] #2}
\newcommand\AMCrep@ligne[2]{\AMCmem@ireAJRep{#1}\mbox{#1\hspace*{1em}#2}\hspace{3em plus 4em}}
\newcommand\AMCrep@perso[2]{\AMCmem@ireAJRep{#1}\AMCanswer{#1}{#2}}
\def\AMCbeginAnswer{}
\def\AMCendAnswer{}
\def\AMCanswer#1#2{#1 #2}
%
\newcommand{\correctchoice}[2][]{\advance\AMCrep@count by 1%
\ifAMC@calibration\AMC@amclog{AUTOQCM[REP=\the\AMCrep@count:B]^^J}\fi%
\AMCune@bonnetrue\AMCload@@reponse{\une@rep{\ifAMC@correc\AMC@marque{#1}{1}\else\AMC@marque{#1}{}\fi}{#2}}{\the\AMCrep@count}}
\newcommand{\wrongchoice}[2][]{\advance\AMCrep@count by 1%
\ifAMC@calibration\AMC@amclog{AUTOQCM[REP=\the\AMCrep@count:M]^^J}\fi%
\AMCload@@reponse{\une@rep{\AMC@marque{#1}{}}{#2}}{\the\AMCrep@count}}
%
\newcounter{AMCquestionaff}
\newcommand{\AMCnumero}[1]{\setcounter{AMCquestionaff}{#1}\addtocounter{AMCquestionaff}{-1}}
\def\AMC@qaff{\addtocounter{AMCquestionaff}{1}\arabic{AMCquestionaff}}
\def\AMCbeginQuestion#1#2{\par\noindent\AMC@loc@q{#1}{#2}\hspace*{1em}}
\def\QuestionIndicative{\ifAMC@calibration\AMC@amclog{AUTOQCM[INDIC]^^J}\fi}
%
\def\multiSymbole{$\clubsuit$}
\def\AMCmessage#1{\AMC@amclog{AUTOQCM[#1]^^J}}
% cancel possible previous definition for \question
\ifx\question\undefined\else\let\question\undefined\fi
\def\AMCnobloc{\AMC@qblocfalse}
\def\AMCbloc{\AMC@qbloctrue}
\newenvironment{question}[2][]{\global\def\AMCid@name{#2}\AMC@affecte{#2}{\AMCid@quest}\ifAMC@calibration\AMCmessage{Q=\the\AMCid@quest}\fi\AMCtype@multifalse\ifAMC@qbloc\noindent\begin{minipage}{\linewidth}\fi\ifAMC@affichekeys\index{{\tt #2}}\fi\AMCbeginQuestion{\ifAMC@affichekeys[{\tt #2}]\else\AMC@qaff\fi}{#1}\AMCformulaire@dedansfalse\setcounter{AMC@ncase}{0}\AMCmem@ireQ{\arabic{AMCquestionaff}}}{\ifAMC@qbloc\end{minipage}\vspace{3ex}\fi\AMCmessage{FQ}}
\def\@aucune{\emph{\AMC@loc@none}}
\newenvironment{questionmult}[1]{\AMCune@bonnefalse\begin{question}[{{\multiSymbole}}]{#1}\AMCtype@multitrue\ifAMC@calibration\AMC@amclog{AUTOQCM[MULT]^^J}\fi}{\end{question}}
\newdimen\ouverte@vs
\newenvironment{questionouverte}[1][3cm]{\AMCtype@multifalse\ouverte@vs=#1\ifAMC@qbloc\noindent\begin{minipage}{\linewidth}\fi\AMCbeginQuestion{\AMC@qaff}{}}{\vspace*{\ouverte@vs}\ifAMC@qbloc\end{minipage}\vspace{3ex}\fi}
%
%
% ----------------------------------------------------------------------------
% coding numerical values with boxes
% ----------------------------------------------------------------------------
%
\newcount\AMC@chiffres
%
\newcommand{\AMCcode}[2]{%
{\def\AMCbeginQuestion##1##2{}%
 \def\AMCbeginAnswer{\begin{minipage}{\ifAMC@ensemble 1.15em\else 2.5em\fi}}%
 \def\AMCendAnswer{\hspace*{\fill}\end{minipage}}%
 \def\AMCanswer##1##2{##1 \ifAMC@ensemble\else{\bf ##2}\fi\\[1mm]}%
 \AMCnobloc%
 \AMC@chiffres=#2\loop%
 \begin{question}{#1.\the\AMC@chiffres}\QuestionIndicative
   \begin{choicescustom}[o]\scoring{auto=0}
     \wrongchoice[0]{0}
     \wrongchoice[1]{1}
     \wrongchoice[2]{2}
     \wrongchoice[3]{3}
     \wrongchoice[4]{4}
     \wrongchoice[5]{5}
     \wrongchoice[6]{6}
     \wrongchoice[7]{7}
     \wrongchoice[8]{8}
     \wrongchoice[9]{9}
   \end{choicescustom}
 \end{question}
 \advance\AMC@chiffres by -1 \ifnum\AMC@chiffres>0\repeat
}}
%
\def\scoring#1{\ifAMC@calibration\AMC@amclog{AUTOQCM[B=#1]^^J}\fi}
%
\def\scoringDefaultS#1{\ifAMC@calibration\AMC@amclog{AUTOQCM[BDS=#1]^^J}\fi}
\def\scoringDefaultM#1{\ifAMC@calibration\AMC@amclog{AUTOQCM[BDM=#1]^^J}\fi}
%
%--------------------------------------------------------------
% automatic answers list with intervals
%--------------------------------------------------------------
%
\def\AMC@intervx#1#2{\AMC@CI@cas{[#1,\ #2[}}
%
% \choixIntervalles{right value}{x0}{x1}{delta}
%
\def\choixIntervalles#1#2#3#4{%
\FPeval\AMC@CI@a{clip(#2)}%
\let\AMC@CI@cas=\wrongchoice
\loop%
  \FPeval\AMC@CI@b{clip(AMC@CI@a + #4)}%
  \FPiflt{#1}\AMC@CI@b\let\AMC@CI@cas=\correctchoice\fi%
  \FPiflt{#1}\AMC@CI@a\let\AMC@CI@cas=\wrongchoice\fi%
  \@expandtwoargs\AMC@intervx{\AMC@CI@a}{\AMC@CI@b}%
\FPiflt\AMC@CI@b{#3}%
  \FPset\AMC@CI@a{\AMC@CI@b}%
\repeat}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% watermark
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareFontShape{OT1}{cmr}{b}{n}{<35->cmr17}{}
\def\AMC@watertext{\AMC@loc@draft}
\newcommand\AMCw@termark{%
  \setlength{\@tempdimb}{.5\paperwidth}%
  \setlength{\@tempdimc}{-.5\paperheight}%
  \put(\strip@pt\@tempdimb,\strip@pt\@tempdimc){%
    \makebox(0,0){\rotatebox{45}{%
        \textcolor[gray]{0.8}{
          \fontencoding{OT1}\fontfamily{cmr}
          \fontseries{b}\fontshape{n}
          \fontsize{90pt}{120pt}
          \selectfont
          \AMC@watertext}}}}}
\newcommand\AMCw@terprint[1]{%
  \setbox\@tempboxa\vbox to \z@{%
    \vbox{%
      \hbox to \z@{%
        #1\hss}}\vss}
  \dp\@tempboxa\z@
  \box\@tempboxa}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% mise en page
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\AMCcercle#1#2{{\setlength{\unitlength}{1mm}\begin{picture}(#1,#1)(-#2,-#2)\thinlines\circle*{#1}\end{picture}}}
\def\m@rqueCalage{\AMCcercle{3.6}{1.8}}
\def\m@rque#1{\tracebox{1}{#1}{\m@rqueCalage}}
\def\he@dtaille#1{\vbox to 1cm{#1}}
\def\he@dbas#1{\he@dtaille{\vspace*{\fill}#1}}
\def\he@dhaut#1{\he@dtaille{#1\vspace*{\fill}}}
\def\AMC@intituleHead{\AMC@loc@corrected}
%
\AtBeginPage{\global\advance\AMCid@check by -1%
\ifnum\AMCid@check<1\global\AMCid@check=\AMCid@checkmax\fi%
\pagepos%
\ifAMC@watermark\ifAMC@correchead\else\AMCw@terprint{\AMCw@termark}\fi\fi}
%
\AtBeginDocument{
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
%
\ifAMC@correchead
\lhead{}\rhead{}\chead{{\sc \AMC@intituleHead}}\lfoot{}\rfoot{}\cfoot{}
\else
\lhead{\he@dbas{\m@rque{positionHG}}}
\rhead{\he@dbas{\m@rque{positionHD}}}
\lfoot{\m@rque{positionBG}}
\rfoot{\m@rque{positionBD}}
\chead{\he@dhaut{%
\ifAMC@codebinaire%
\begin{minipage}[b]{\AMC@CBtaille}
\commence@nb{1}\noindent\binaire[\AMC@NCBetud]{\the\AMCid@etud}\\
\commence@nb{2}\noindent\binaire[\AMC@NCBpage]{\thepage}\commence@nb{3}\binaire[\AMC@NCBcheck]{\the\AMCid@check}%
\end{minipage}
\hbox to 4cm{\hspace*{\fill}{\tt +\the\AMCid@etud/\thepage/\the\AMCid@check+}}%
\else%
\LARGE\tt +\the\AMCid@etud/\thepage/\the\AMCid@check+%
\fi}}
\fancyhfoffset[EOLR]{5mm}
\fi
\cfoot{\AMC@note}
}
\def\AMC@note{}
%
\newcommand{\onecopy}[2]{%
\ifx\AMCNombreCopies\undefined\AMCnum@copies=#1\else\AMCnum@copies=\AMCNombreCopies\fi%
\AMC@amclog{AUTOQCM[TOTAL=\the\AMCnum@copies]^^J}%
\AMCid@etud=\AMC@premierecopie\AMCid@etudfin=\AMCnum@copies\advance\AMCid@etudfin by \AMC@premierecopie%
\ifAMC@correchead\AMCid@etudfin=\AMC@premierecopie\fi
\loop \AMC@zoneformulairefalse\setcounter{page}{1}\AMCnumero{1}\ifAMC@calibration\AMC@amclog{AUTOQCM[ETU=\the\AMCid@etud]^^J}\fi #2\advance\AMCid@etud by 1 \ifnum\AMCid@etud<\AMCid@etudfin\repeat%
}
%
\def\AMCcleardoublepage{\ifodd\thepage\clearpage~\fi\clearpage}
%
\def\exemplairepair{\ifodd\AMCid@etud}
%
%
% label/ref inside sheets
%
\def\AMCref#1{\expandafter\ref{\the\AMCid@etud-#1}}
\def\AMClabel#1{\expandafter\label{\the\AMCid@etud-#1}}
%
%--------------------------------------------------------------
% Options
%--------------------------------------------------------------
\DeclareOption{noshuffle}{\AMC@ordretrue}
\DeclareOption{answers}{\AMC@correcheadtrue\AMC@correctrue}
\DeclareOption{indivanswers}{\AMC@correctrue}
\DeclareOption{box}{\AMC@qbloctrue}
\DeclareOption{separateanswersheet}{\AMC@ensembletrue}
\DeclareOption{digits}{\AMC@ensemble@chiffrestrue}
%
\DeclareOption{ordre}{\AMC@ordretrue}
\DeclareOption{correc}{\AMC@correcheadtrue\AMC@correctrue}
\DeclareOption{modele}{\AMC@correcheadtrue\AMC@correcfalse\AMC@ordretrue}
\DeclareOption{correcindiv}{\AMC@correctrue}
\DeclareOption{init}{\AMC@SR@time}
\DeclareOption{bloc}{\AMC@qbloctrue}
\DeclareOption{completemulti}{\AMCcomplete@multitrue}
\DeclareOption{ensemble}{\AMC@ensembletrue}
\DeclareOption{chiffres}{\AMC@ensemble@chiffrestrue}
%
\DeclareOption{calibration}{\AMC@calibrationtrue}
\DeclareOption{binaire}{\AMC@codebinairetrue} % par defaut
\DeclareOption{decimal}{\AMC@codebinairefalse\def\AMCid@checkmax{999}}
\DeclareOption{nowatermark}{\AMC@watermarkfalse}
%
\DeclareOption{catalog}{\AMC@watermarkfalse\AMC@correcheadtrue\AMC@correctrue\AMC@ordretrue\def\AMC@intituleHead{\AMC@loc@catalog}\AMC@affichekeystrue}
%
\DeclareOption{francais}{\AMC@loc@FR}
%
\DeclareOption{versionA}{\def\AMCid@checkmax{31}\def\AMC@NCBetud{9}\def\AMC@NCBpage{4}\def\AMC@NCBcheck{5}\setlength{\AMC@CBtaille}{4cm}\def\AMC@premierecopie{100}}
\DeclareOption{plain}{\AMC@plaintrue}
%
\ProcessOptions
%
% Tries to see if optional packages environ and etex are loadable,
% and load them if possible.
% This can be cancelled by using " plain" option.
\ifAMC@plain
\else
  \IfFileExists{environ.sty}{\RequirePackage{environ}}{}
  \ifx\eTeXversion\@undefined
  \else
    \RequirePackage{etex}
  \fi
\fi
%
\ifx\SujetExterne\undefined\else
\message{***SUJET***^^J}
\AMC@calibrationtrue\AMC@correcfalse\AMC@correcheadfalse\AMC@watermarkfalse
\fi
%
\ifx\CalibrationExterne\undefined\else
\message{***CALIBRATION***^^J}
\AMC@calibrationtrue\AMC@correcfalse\AMC@correcheadfalse\AMC@watermarkfalse
\fi
%
\ifx\CorrigeExterne\undefined\else
\message{***CORRIGE***^^J}
\AMC@calibrationfalse\AMC@correcheadtrue\AMC@correctrue\AMC@watermarkfalse
\fi
%
\ifx\CorrigeIndivExterne\undefined\else
\message{***CORRIGE***^^J}
\AMC@correctrue\AMC@watermarkfalse
\fi
%
\ifx\NoWatermarkExterne\undefined\else
\AMC@watermarkfalse
\fi
%
\@ifpackageloaded{geometry}{}{\usepackage{geometry}}
\ifAMC@correchead
\geometry{hmargin=3cm,vmargin={1cm,1cm},includeheadfoot,headheight=1cm,footskip=1cm}
\else
\geometry{hmargin=3cm,headheight=2cm,headsep=.3cm,footskip=1cm,top=3.5cm,bottom=2.5cm}
\fi
\AMCid@check=\AMCid@checkmax\advance\AMCid@check by 1
%
\ifAMC@watermark
\ifAMC@correchead\else
  \def\AMC@note{\begin{minipage}{0.65\linewidth}
      \textcolor{blue}{\AMC@loc@message}
    \end{minipage}
  }
\fi
\fi
%
% examcopy environment
%
\@ifpackageloaded{environ}{%
\NewEnviron{examcopy}[1][5]{\onecopy{#1}{\BODY}}
}{\PackageWarning{automultiplechoice}{Package environ not loaded: environnement examcopy/copieexamen will NOT be defined.}}
% VARS
\ifAMC@ensemble\AMC@amclog{AUTOQCM[VAR:ensemble=1]^^J}\fi
%
\ifAMC@calibration
\newwrite\AMC@XYFILE%
\immediate\openout\AMC@XYFILE\jobname.xy%
\fi
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% french commands localisation
% allways active, for backward compatibility
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\let\reponses=\choices\let\endreponses=\endchoices
\let\reponseshoriz=\choiceshoriz\let\endreponseshoriz=\endchoiceshoriz
\let\reponsesperso=\choicescustom\let\endreponsesperso=\endchoicescustom
\let\bonne=\correctchoice
\let\mauvaise=\wrongchoice
\let\bareme=\scoring
\let\baremeDefautM=\scoringDefaultM
\let\baremeDefautS=\scoringDefaultS
\def\exemplaire{\AMC@loc@FR\onecopy}
\@ifpackageloaded{environ}{
\let\copieexamen=\examcopy\let\endcopieexamen=\endexamcopy
}{}
\let\melangegroupe=\shufflegroup
\let\restituegroupe=\insertgroup
\let\alafin=\lastchoices
\let\formulaire=\AMCform
\let\AMCdebutFormulaire=\AMCformBegin
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
