%
% Copyright (C) 2008 Alexis Bienvenue
%
% This file is part of Auto-Multiple-Choice
%
% Auto-Multiple-Choice is free software: you can redistribute it
% and/or modify it under the terms of the GNU General Public License
% as published by the Free Software Foundation, either version 3 of
% the License, or (at your option) any later version.
%
% Auto-Multiple-Choice is distributed in the hope that it will be
% useful, but WITHOUT ANY WARRANTY; without even the implied warranty
% of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with Auto-Multiple-Choice.  If not, see
% <http://www.gnu.org/licenses/>.
%
% $Revision$
% 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{automultiplechoice}
\RequirePackage{theorem,graphicx}
\RequirePackage[geometry]{ifsym}
\RequirePackage{xcolor}
\RequirePackage{fancyhdr}
\RequirePackage{everypage}
%\RequirePackage{multido}
%%% debug -> diagnostiquer un no room for a new \count
%\let\newcount@@=\newcount
%\def\newcount#1{\newcount@@{#1}\message{^^JNEWCOUNT=#1^^J}}
%
%--------------------------------------------------------------
% generateur aleatoire de bits, cf. TuGBoat1994, vol 15,1
%--------------------------------------------------------------
\ifx\AMC@SR\undefined\newcount\AMC@SR\fi
\providecommand\AMC@SRconst{2097152}
\providecommand\AMC@SRset[1]{\global\AMC@SR#1 \ignorespaces}
\providecommand\AMC@SRadvance{%
  \begingroup
  \ifnum\AMC@SR<\AMC@SRconst\relax\AMC@SR@count\z@\else\AMC@SR@count\@ne\fi
  \ifodd\AMC@SR\advance\AMC@SR@count\@ne\fi
  \global\divide\AMC@SR\tw@
  \ifodd\AMC@SR@count\global\advance\AMC@SR\AMC@SRconst\relax\fi
  \endgroup}
\providecommand\AMC@SRbit{\AMC@SRadvance\ifodd\AMC@SR1\else0\fi}
\providecommand\AMC@SRtest[2]{\AMC@SRadvance
  \ifodd\AMC@SR#2\else#1\fi\ignorespaces}
\providecommand\AMC@SRvalue{\number\AMC@SR }
\AMC@SRset{1515}
%
\def\AMCrandomseed#1{\AMC@SRset{#1}}
%--------------------------------------------------------------
% pour tirer des *nombres* (presque) uniformement
%--------------------------------------------------------------
\newcount\AMC@SR@count
\def\AMC@SR@time{\AMC@SRset{\time}}
\newcount\AMC@SRnum
\def\AMC@SRnextByte{\AMC@SRnum=0
\AMC@SR@count=20
\loop\multiply\AMC@SRnum by 2
     \AMC@SRtest{\advance\AMC@SRnum by 1}{}
\ifnum\AMC@SR@count>1\advance\AMC@SR@count by -1\repeat
}
% fabrique un entier de zero a #1-1 dans \AMC@SRnum
% #1 peut valoir au maximum 2^20
\newcommand\AMC@SRmax[1]{\AMC@SRnextByte
\AMC@SR@count=\AMC@SRnum
\divide\AMC@SR@count by #1
\multiply\AMC@SR@count by #1
\advance\AMC@SRnum by -\AMC@SR@count
}
%--------------------------------------------------------------
% melange aleatoire de tokens
%--------------------------------------------------------------
\newcount\AMC@sti
\newtoks\AMCsw@p@
\newcommand\AMCsw@p[2]{\global\AMCsw@p@=#1 \global #1=#2 \global #2=\AMCsw@p@}
\newcommand\AMC@shuffletoks[2]{ % nbre_de_toks nom_de_base
  \AMC@sti=#1
  \@whilenum\AMC@sti>1\do{
  \AMC@SRmax{\AMC@sti}\advance\AMC@SRnum by 1
% pour debogage : affiche les permutations effectuees
%  \number\AMC@SRnum$\leftrightarrow$\number\AMC@sti\par
  \AMCsw@p{\csname #2\romannumeral\AMC@SRnum\endcsname}{\csname #2\romannumeral\AMC@sti\endcsname}
  \advance\AMC@sti by -1
}}
%--------------------------------------------------------------
% affecte un numero unique a chaque cle utilisee...
%--------------------------------------------------------------
% definit la valeur asociee a une cle
\def\AMC@definitnumero#1#2{\message{AUTOQCM[NUM=#1=#2]^^J}\expandafter\global\expandafter\def\csname AMC@numtab@#2\endcsname{#1}}
% le compteur des numeros deja utilises
\newcount\AMC@numerotation\AMC@numerotation=1
% renvoie, si elle existe, la valeur deja associee, ou en associe une
% nouvelle et la renvoie
\def\AMC@prepare#1{\expandafter\ifx\csname AMC@numtab@#1\endcsname\relax\global\advance\AMC@numerotation by 1\expandafter\AMC@definitnumero\expandafter{\the\AMC@numerotation}{#1}\fi}
\def\AMC@unnumero#1{\AMC@prepare{#1}\csname AMC@numtab@#1\endcsname}
\def\AMC@affecte#1#2{\AMC@prepare{#1}#2=\csname AMC@numtab@#1\endcsname}
%
%--------------------------------------------------------------
% general
%--------------------------------------------------------------
\newcount\AMCload@counter % nombre de reponses chargees pour la question en cours
\newcount\AMCnum@questions
\newcount\AMCid@quest\AMCid@quest=-1 % numero de la question en cours
\newcount\AMCid@check % code de verification de la question en cours
\def\AMCid@checkmax{31} % code de verification maximal
\newcount\AMCid@etud\AMCid@etud=100 % numero de la copie en cours
\newcount\AMCid@etudfin % numero de la copie a laquelle on va s'arreter
% options :
\newif\ifAMC@ordre\AMC@ordrefalse % on laisse les reponses dans l'ordre
\newif\ifAMC@correchead\AMC@correcheadfalse % en-tete corrige
\newif\ifAMC@correc\AMC@correcfalse % corrige des questions
\newif\ifAMC@qbloc\AMC@qblocfalse % on met les questions dans des blocs, pour ne pas les couper par des sauts de page
\newif\ifAMCcomplete@multi\AMCcomplete@multifalse % on complete les questions multi par une option "rien n'est bon"
\newif\ifAMC@calibration\AMC@calibrationfalse % on veut fabriquer le document de calibration (couleurs speciales)
\newif\ifAMC@codebinaire\AMC@codebinairetrue % le code est ecrit en binaire
\newif\ifAMC@couleur\AMC@couleurtrue
\newif\ifAMCune@bonne % il y a au moins une bonne reponse dans la question en cours
\newif\ifAMCtype@multi % la question en cours est de type multiple
\newif\ifAMC@watermark\AMC@watermarktrue
%
%
% cases cochees ou non avec la bonne couleur et la bonne forme
\newcommand{\AMC@marquebonne}{\ifAMC@calibration\ifAMC@couleur\textcolor[RGB]{200,\the\AMCid@quest,\the\AMCrep@count}{\FilledBigSquare}\else[B\the\AMCid@quest,\the\AMCrep@count]\fi\else\FilledBigSquare\fi}
\newcommand{\AMC@marquevide}{\ifAMC@calibration\ifAMC@couleur\textcolor[RGB]{200,\the\AMCid@quest,\the\AMCrep@count}{\BigSquare}\else[M\the\AMCid@quest,\the\AMCrep@count]\fi\else\BigSquare\fi}
% champ a remplir pour mettre son nom -> bonne couleur
\newcommand{\champnom}[1]{\colorbox{souschampnom}{#1}}
%
%--------------------------------------------------------------
% groupes et melange des elements du groupe
%--------------------------------------------------------------
%
\newcount\AMCtok@k
\newcount\AMCtok@max
\newcommand{\nouveaugroupe}[2]{% nom_groupe nombre_max
\AMCtok@k=#2
% definition des registres de tokens
\@whilenum\AMCtok@k>0\do{
  \expandafter\newtoks\csname #1@\romannumeral\AMCtok@k\endcsname
  \advance\AMCtok@k by -1
}
% definition du compteur
\expandafter\newcount\csname #1@k\endcsname
\csname #1@k\endcsname=0
}
\newcommand{\element}[2]{% nom_groupe tok
  \advance\csname #1@k\endcsname by 1
  \AMCtok@k=\csname #1@k\endcsname
%  < \the\AMCtok@k >
  \csname #1@\romannumeral\AMCtok@k\endcsname={#2}
}
\newcommand{\melangegroupe}[1]{%
  {\AMC@shuffletoks{\number\csname #1@k\endcsname}{#1@}}
}
\newcommand{\restituegroupe}[2][0]{%
\AMCtok@max=#1
\ifnum\the\AMCtok@max<1
  \AMCtok@max=\csname #2@k\endcsname
\fi
\AMCtok@k=0
% \@whilenum\AMCtok@k<\AMCtok@max\do{
%   \advance\AMCtok@k by 1
%   \the\csname #2@\romannumeral\AMCtok@k\endcsname
%   }
{\loop
    \advance\AMCtok@k by 1
    \the\csname #2@\romannumeral\AMCtok@k\endcsname
\ifnum\AMCtok@k<\AMCtok@max\repeat}%
}
%
%--------------------------------------------------------------
% questions
%--------------------------------------------------------------
%
\newcount\AMCrep@count
\newcount\AMCrep@@count
% nbre maximal de reponses :
\AMCload@counter=20
% definition des registres de tokens
\@whilenum\AMCload@counter>0\do{
  \expandafter\newtoks\csname reponse@\romannumeral\AMCload@counter\endcsname
  \advance\AMCload@counter by -1
}
\newcommand\AMCload@reponse[2]{%
  \advance\AMCload@counter by 1
  \csname reponse@\romannumeral\AMCload@counter\endcsname=\expandafter{\expandafter\AMCrep@count\expandafter=#2 #1}
}
\newcommand\AMCrien@deux[2]{#1}
\newcommand\AMCdump@reponses{\global\AMCnum@questions=\AMCload@counter\@whilenum\AMCload@counter>0\do{\the\csname reponse@\romannumeral\AMCload@counter\endcsname\advance\AMCload@counter by -1}}
\def\shuffle@it{\AMC@shuffletoks{\number\AMCload@counter}{reponse@}}
%
\newcommand\AMCrep@init[1]{\ifAMC@ordre\AMCrep@o\else\csname AMCrep@#1\endcsname\fi\AMCload@counter=0}
\newcommand\alafin{\AMCrep@@count=\AMCrep@count\AMCrep@fini\AMCrep@init{o}\AMCrep@count=\AMCrep@@count}
\newcommand\AMC@fin@rep{\ifAMCcomplete@multi\ifAMCtype@multi\alafin\AMCrep@count=-1\ifAMCune@bonne\mauvaise{\@aucune}\else\bonne{\@aucune}\fi\fi\fi\AMCrep@fini}
\newenvironment{reponses}[1][r]{\AMCrep@count=0\def\une@rep{\AMCrep@itemize}\begin{itemize}\AMCrep@init{#1}}{\AMC@fin@rep\end{itemize}}
%
\newenvironment{reponseshoriz}[1][r]{\AMCrep@count=0\def\une@rep{\AMCrep@ligne}\AMCrep@init{#1}\par\begin{center}}{\AMC@fin@rep\end{center}}
%
\newcommand\AMCrep@o{\def\AMCload@@reponse{\AMCrien@deux}\def\AMCrep@fini{}}
\newcommand\AMCrep@r{\def\AMCload@@reponse{\AMCload@reponse}\def\AMCrep@fini{\shuffle@it\AMCdump@reponses}}
\newcommand\AMCrep@itemize[2]{\item[#1]{#2}}
\newcommand\AMCrep@ligne[2]{\mbox{#1\hspace*{1em}#2}\hspace{3em plus 4em}}
%
\newcommand{\bonne}[1]{\advance\AMCrep@count by 1%
\ifAMC@calibration\message{AUTOQCM[REP=\the\AMCrep@count:B]^^J}\fi%
\AMCune@bonnetrue\AMCload@@reponse{\une@rep{\ifAMC@correc\AMC@marquebonne\else\AMC@marquevide\fi}{#1}}{\the\AMCrep@count}}
\newcommand{\mauvaise}[1]{\advance\AMCrep@count by 1%
\ifAMC@calibration\message{AUTOQCM[REP=\the\AMCrep@count:M]^^J}\fi%
\AMCload@@reponse{\une@rep{\AMC@marquevide}{#1}}{\the\AMCrep@count}}
%
\theoremstyle{plain}
\theorembodyfont{\rm}
\newtheorem{questionA}{Question}
\def\multiSymbole{$\clubsuit$}
\def\AMCmessage#1{\message{AUTOQCM[#1]^^J}}
% annule une definition precedente (exercices.sty, par ex.)
\ifx\question\undefined\else\let\question\undefined\fi
\newenvironment{question}[2][]{\AMC@affecte{#2}{\AMCid@quest}\ifAMC@calibration\AMCmessage{Q=\the\AMCid@quest}\fi\AMCtype@multifalse\ifAMC@qbloc\noindent\begin{minipage}{\linewidth}\fi\begin{questionA}#1}{\end{questionA}\ifAMC@qbloc\end{minipage}\vspace{3ex}\fi}
\def\@aucune{\emph{Aucune de ces r\'eponses n'est correcte.}}
\newenvironment{questionmult}[1]{\AMCune@bonnefalse\begin{question}{#1}[{{\multiSymbole}}]\AMCtype@multitrue\ifAMC@calibration\message{AUTOQCM[MULT]^^J}\fi}{\end{question}}
\newdimen\ouverte@vs
\newenvironment{questionouverte}[1][3cm]{\AMCtype@multifalse\ouverte@vs=#1\begin{questionA}}{\vspace*{\ouverte@vs}\end{questionA}}
%
\def\bareme#1{\ifAMC@calibration\message{AUTOQCM[B=#1]^^J}\fi}
%
%--------------------------------------------------------------
% liste automatique de reponses...
%--------------------------------------------------------------
%
\def\AMC@intervx#1#2{\AMC@CI@cas{[#1,\ #2[}}
% \choixIntervalles{bonne valeur}{x0}{x1}{delta}
\def\choixIntervalles#1#2#3#4{%
\FPeval\AMC@CI@a{clip(#2)}%
\let\AMC@CI@cas=\mauvaise
\loop%
  \FPeval\AMC@CI@b{clip(AMC@CI@a + #4)}%
  \FPiflt{#1}\AMC@CI@b\let\AMC@CI@cas=\bonne\fi%
  \FPiflt{#1}\AMC@CI@a\let\AMC@CI@cas=\mauvaise\fi%
  \@expandtwoargs\AMC@intervx{\AMC@CI@a}{\AMC@CI@b}%
\FPiflt\AMC@CI@b{#3}%
  \FPset\AMC@CI@a{\AMC@CI@b}%
\repeat}
%
%--------------------------------------------------------------
% ecriture en binaire
%--------------------------------------------------------------
%
\newtoks\en@binaire
\newcount\le@nombre
\newcount\nb@chiffres
\newcount\nb@id
\newcount\numer@casebinaire
\newdimen\largeur@case\largeur@case=.3cm
\newif\ifcase@pleine
\def\case@couleur#1{{\fboxsep=0pt\fboxrule=.5pt\fcolorbox{colcasebin}{#1}{\vbox to \largeur@case{\hbox to \largeur@case{\hspace*{\fill}}\vspace*{\fill}}}}}
\def\couleur@case{\ifAMC@calibration\ifAMC@couleur\advance\numer@casebinaire by 1\definecolor{colcasebin}{RGB}{201,\the\nb@id,\the\numer@casebinaire}\else\definecolor{colcasebin}{RGB}{0,0,0}\fi\else\definecolor{colcasebin}{RGB}{0,0,0}\fi}
\def\chiffre@zero{\couleur@case\case@couleur{white}}
\def\chiffre@un{\couleur@case\case@couleur{colcasebin}}
%\def\casebinaire#1{\ifAMC@calibration\ifAMC@couleur\advance\numer@casebinaire by 1\textcolor[RGB]{201,\the\nb@id,\the\numer@casebinaire}{#1}\else #1\fi\else #1\fi}
%\def\chiffre@zero{\casebinaire{\BigSquare}}
%\def\chiffre@un{\casebinaire{\FilledBigSquare}}
\def\commence@nb#1{\nb@id=#1\numer@casebinaire=0}
\newcommand\chiffresbinaires[2]{
\def\chiffre@zero{#1}
\def\chiffre@un{#2}
}
\newcommand{\binaire}[2][1]{%
\en@binaire={}\le@nombre=#2%
\nb@chiffres=0%
\loop%
\ifnum\le@nombre>0%
\advance\nb@chiffres by 1%
\ifodd\le@nombre\en@binaire=\expandafter{\expandafter\chiffre@un\the\en@binaire}%
\else\en@binaire=\expandafter{\expandafter\chiffre@zero\the\en@binaire}\fi%
\divide\le@nombre by 2%
\repeat%
\loop\relax%
\ifnum\nb@chiffres<#1\advance\nb@chiffres by 1%
\en@binaire=\expandafter{\expandafter\chiffre@zero\the\en@binaire}\repeat%
\the\en@binaire%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% watermark
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareFontShape{OT1}{cmr}{b}{n}{<35->cmr17}{}
\def\AMC@watertext{PROJET}
\newcommand\AMCw@termark{%
  \setlength{\@tempdimb}{.5\paperwidth}%
  \setlength{\@tempdimc}{-.5\paperheight}%
  \put(\strip@pt\@tempdimb,\strip@pt\@tempdimc){%
    \makebox(0,0){\rotatebox{45}{%
        \textcolor[gray]{0.8}{
          \fontencoding{OT1}\fontfamily{cmr}
          \fontseries{b}\fontshape{n}
          \fontsize{90pt}{120pt}
          \selectfont
          \AMC@watertext}}}}}
\newcommand\AMCw@terprint[1]{%
  \setbox\@tempboxa\vbox to \z@{%
    \vskip -1in \moveleft 1in \vbox{%
      \hbox to \z@{%
        #1\hss}}\vss}
  \dp\@tempboxa\z@
  \box\@tempboxa}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% mise en page
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\m@rque#1{\textcolor{#1}{\FilledBigCircle}}
\def\he@dtaille#1{\vbox to 1cm{#1}}
\def\he@dbas#1{\he@dtaille{\vspace*{\fill}#1}}
\def\he@dhaut#1{\he@dtaille{#1\vspace*{\fill}}}
\AtBeginDocument{
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\ifAMC@correchead
\lhead{}\rhead{}\chead{{\sc Correction}}\lfoot{}\rfoot{}\cfoot{\thepage}
\else
\lhead{\he@dbas{\m@rque{positionHG}}}
\rhead{\he@dbas{\m@rque{positionHD}}}
\lfoot{\m@rque{positionBG}}
\rfoot{\m@rque{positionBD}}
\chead{\global\advance\AMCid@check by -1%
\ifnum\AMCid@check<1\global\AMCid@check=\AMCid@checkmax\fi%
\he@dhaut{%
\ifAMC@codebinaire%
\begin{minipage}[b]{4cm}
\commence@nb{1}\noindent\binaire[9]{\the\AMCid@etud}\\
\commence@nb{2}\noindent\binaire[4]{\thepage}\commence@nb{3}\binaire[5]{\the\AMCid@check}%
\end{minipage}
\hbox to 4cm{\hspace*{\fill}{\tt +\the\AMCid@etud/\thepage/\the\AMCid@check+}}%
\else%
\LARGE\tt +\the\AMCid@etud/\thepage/\the\AMCid@check+%
\fi}}
\fancyhfoffset[EOLR]{5mm}
\fi
\cfoot{\AMC@note}
}
\def\AMC@note{}
%
\newcommand{\exemplaire}[2]{%\ifAMC@correc #2\else%
\AMCid@etud=100\AMCid@etudfin=#1\advance\AMCid@etudfin by 100%
\ifAMC@correchead\AMCid@etudfin=100\fi
\loop \setcounter{page}{1}\setcounter{questionA}{0}\message{[AUTOQCM[ETU=\the\AMCid@etud]^^J} #2\advance\AMCid@etud by 1 \ifnum\AMCid@etud<\AMCid@etudfin\repeat%
%\fi%
}
%
%\newenvironment{exemplaires}[1][10]{\exemplaire{#1}\bgroup}{\egroup}
%
\def\exemplairepair{\ifodd\AMCid@etud}
%--------------------------------------------------------------
% Options
%--------------------------------------------------------------
\DeclareOption{ordre}{\AMC@ordretrue}
\DeclareOption{correc}{\AMC@correcheadtrue\AMC@correctrue}
\DeclareOption{correcindiv}{\AMC@correctrue}
\DeclareOption{init}{\AMC@SR@time}
\DeclareOption{bloc}{\AMC@qbloctrue}
\DeclareOption{completemulti}{\AMCcomplete@multitrue}
%
\DeclareOption{calibration}{\AMC@calibrationtrue}
\DeclareOption{binaire}{\AMC@codebinairetrue\def\AMCid@checkmax{31}} % par defaut
\DeclareOption{decimal}{\AMC@codebinairefalse\def\AMCid@checkmax{999}}
\DeclareOption{couleur}{\AMC@couleurtrue}
\DeclareOption{id}{\AMC@couleurfalse}
\DeclareOption{nowatermark}{\AMC@watermarkfalse}
%
\ProcessOptions
%
\ifx\CalibrationExterne\undefined\else\AMC@calibrationtrue\AMC@correcheadfalse\message{***CALIBRATION***^^J}\fi
%
\ifx\SujetExterne\undefined\else
\message{***SUJET***^^J}
\AMC@calibrationfalse\AMC@correcfalse\AMC@correcheadfalse
\fi
%
\ifx\CorrigeExterne\undefined\else
\message{***CORRIGE***^^J}
\AMC@calibrationfalse\AMC@correcheadtrue\AMC@correctrue
\fi
%
\ifx\NoWatermarkExterne\undefined\else
\AMC@watermarkfalse
\fi
%
\definecolor{souschampnom}{RGB}{255,255,255}
\definecolor{positionHG}{RGB}{0,0,0}
\definecolor{positionHD}{RGB}{0,0,0}
\definecolor{positionBG}{RGB}{0,0,0}
\definecolor{positionBD}{RGB}{0,0,0}
\ifAMC@calibration\ifAMC@couleur
  \definecolor{souschampnom}{RGB}{201,255,255}
  \definecolor{positionHG}{RGB}{201,100,1}
  \definecolor{positionHD}{RGB}{201,100,2}
  \definecolor{positionBG}{RGB}{201,100,4}
  \definecolor{positionBD}{RGB}{201,100,3}
\fi\fi
%
\ifAMC@correchead
\usepackage[a4paper,hmargin=3cm,vmargin={2cm,2cm}]{geometry}
\else
\usepackage[a4paper,hmargin=3cm,headheight=2cm,headsep=.3cm,footskip=1cm,top=3cm,bottom=2.5cm]{geometry}
\fi
\AMCid@check=\AMCid@checkmax\advance\AMCid@check by 1
%
\ifAMC@watermark
\ifAMC@correchead\else
  \AddEverypageHook{\AMCw@terprint{\AMCw@termark}}
  \def\AMC@note{\begin{minipage}{0.6\linewidth}
      \textcolor{blue}{Pour votre examen, imprimez de préférence les documents fabriqués à l'aide de auto-multiple-choice.}
    \end{minipage}
  }
\fi
\fi
