# -*- Makefile -*-

SHELL=/bin/sh

HVERSION=htdocs/version.shtml

TMPDIR:=$(shell mktemp -d)

DOCVERSION=0.349
TEST_DEB="../auto-multiple-choice_0.346-1_amd64.deb"
#TEST_DEB=`../auto-qcm/local/derniere-version.pl --mode f --base ../auto-qcm/download_area/files/debian/pool/main/a/auto-multiple-choice`

TEST_XML=$(TMPDIR)/usr/share/doc/auto-multiple-choice/auto-multiple-choice
TEST_BASE=$(TMPDIR)/auto-multiple-choice

SITEDOC=htdocs/auto-multiple-choice

version:
	../auto-qcm/local/derniere-version.pl --mode h --fich $(TEST_DEB) > $(HVERSION)
	echo '<!--#set var="DOCVERSION" value="$(DOCVERSION)"-->' >> $(HVERSION)

map: FORCE
	./sitemap.pl --repertoire htdocs --root http://home.gna.org/auto-qcm --o htdocs/sitemap.xml

$(TEST_XML): FORCE
	dpkg-deb -x $(TEST_DEB) $(TMPDIR)
	-gunzip $@.fr.xml.gz
	-gunzip $@.en.xml.gz

$(TEST_BASE).%: $(TEST_XML)
	dblatex -t tex $<.$*.xml -o $@.tex
	perl ../auto-qcm/doc/addlink.pl $@.tex
	cd `dirname $@`; pdflatex `basename $@` ; pdflatex `basename $@`

# doc a partir de la derniere version dans testing
doc: FORCE $(TEST_XML) $(TEST_BASE).fr $(TEST_BASE).en
	$(MAKE) -C ../auto-qcm/ doc/doc-xhtml-site.fr.xsl doc/doc-xhtml-site.en.xsl
	xsltproc --nonet --stringparam base.dir $(SITEDOC).fr/ ../auto-qcm/doc/doc-xhtml-site.fr.xsl $(TEST_XML).fr.xml
	xsltproc --nonet --stringparam base.dir $(SITEDOC).en/ ../auto-qcm/doc/doc-xhtml-site.en.xsl $(TEST_XML).en.xml
	cp $(TEST_BASE).fr.pdf  ../auto-qcm/download_area/files/auto-multiple-choice.fr.pdf
	cp $(TEST_BASE).en.pdf  ../auto-qcm/download_area/files/auto-multiple-choice.en.pdf

site: version doc map
	$(MAKE) -C ../auto-qcm/download_area signe sync

FORCE: ;

.PHONY: site version map FORCE
