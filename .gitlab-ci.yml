
stages:
  - build
  - deploy

job0:
  stage: build
  image: jojoboulix/amc-build
  script:
  - make version_files
  - make
  - make install && texhash
  - make -C tests blind-test
  - make -C doc check
  - make sources
  - export TARBALL=auto-multiple-choice_$(git describe --tags)_dist.tar.gz
  - "mv tarballs/auto-multiple-choice_*_precomp.tar.gz $TARBALL"
  artifacts:
    paths:
    - '*_dist.tar.gz'

job1:
  only:
    refs:
      - master
  stage: deploy
  image: alpine
  before_script:
    - apk add openssh-client
    - eval $(ssh-agent -s)
    - ssh-add - < $PRECOMP_KEY
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - test "$SSH_CONFIG_FILE" && cp $SSH_CONFIG_FILE ~/.ssh/config
    - "scp -o StrictHostKeyChecking=no *_dist.tar.gz $PRECOMP_USER@$PRECOMP_SERVER:precomp 2> /dev/null"
